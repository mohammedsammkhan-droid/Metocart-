<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metocart AI | Merchant OS</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #6366f1; --dark-bg: #0f172a; --card-bg: #1e293b; --text-main: #f8fafc; --accent: #10b981; }
        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--dark-bg); color: var(--text-main); }
        
        #loginScreen { height: 100vh; display: flex; justify-content: center; align-items: center; background: radial-gradient(circle at top right, #1b1b4b, #0f172a); }
        .login-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); padding: 40px; border-radius: 24px; width: 320px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        
        .sidebar { width: 260px; background: #020617; position: fixed; height: 100%; padding: 24px; border-right: 1px solid #1e293b; }
        .nav-btn { width: 100%; padding: 14px; margin: 8px 0; background: transparent; color: #94a3b8; border: none; border-radius: 12px; text-align: left; cursor: pointer; transition: 0.2s; font-weight: 600; }
        .nav-btn.active { background: var(--primary); color: white; }
        
        .main-content { margin-left: 280px; padding: 40px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: var(--card-bg); padding: 24px; border-radius: 20px; border: 1px solid #334155; }
        
        .card { background: var(--card-bg); padding: 25px; border-radius: 20px; border: 1px solid #334155; margin-bottom: 20px; }
        input, select { background: #0f172a; border: 1px solid #334155; border-radius: 8px; padding: 12px; color: white; margin: 5px 0; width: 100%; box-sizing: border-box; }
        button.action-btn { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 700; width: 100%; transition: 0.3s; }
        button.action-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; color: #94a3b8; padding: 12px; border-bottom: 1px solid #334155; }
        td { padding: 12px; border-bottom: 1px solid #1e293b; }
        .section { display: none; }
        .active-section { display: block; }

        /* Print Styles for the specific slip */
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-card">
        <h1 style="color:var(--primary)">Metocart <span style="color:white">AI</span></h1>
        <p style="color:#94a3b8; font-size: 0.9em; margin-bottom: 20px;">Merchant OS v1.0</p>
        <input type="text" id="username" placeholder="Username" value="admin">
        <input type="password" id="password" placeholder="Password" value="1234">
        <button class="action-btn" onclick="login()">Sign In</button>
    </div>
</div>

<div class="dashboard-container" id="dashboard" style="display:none">
    <div class="sidebar">
        <h2 style="color:var(--primary); margin-bottom: 30px;">Metocart</h2>
        <button class="nav-btn active" onclick="showTab('home')">üè† Dashboard</button>
        <button class="nav-btn" onclick="showTab('inventory')">üì¶ Smart Inventory</button>
        <button class="nav-btn" onclick="showTab('customers')">üë• Customers</button>
        <button class="nav-btn" onclick="showTab('billing')">üßæ GST Billing</button>
        <button class="nav-btn" onclick="showTab('ai')">ü§ñ AI Advisor</button>
        <button class="nav-btn" style="margin-top: 50px; color:#ef4444" onclick="location.reload()">üîí Logout</button>
    </div>

    <div class="main-content">
        <div id="home" class="section active-section">
            <h1>Business Overview</h1>
            <div class="kpi-grid">
                <div class="kpi-card"><p>Revenue</p><h2 id="rev">‚Çπ0</h2></div>
                <div class="kpi-card"><p>Profit</p><h2 id="profit">‚Çπ0</h2></div>
                <div class="kpi-card"><p>GST Collected</p><h2 id="gstTotal">‚Çπ0</h2></div>
                <div class="kpi-card"><p>Stock Value</p><h2 id="invValue">‚Çπ0</h2></div>
            </div>
        </div>

        <div id="inventory" class="section">
            <div class="card">
                <h2>Product Catalog</h2>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <input id="pname" placeholder="Item Name">
                    <input id="pcategory" placeholder="HSN Code">
                    <input type="number" id="pcost" placeholder="Cost Price">
                    <input type="number" id="psell" placeholder="Selling Price">
                    <input type="number" id="pqty" placeholder="Stock Qty">
                </div>
                <button class="action-btn" style="margin-top:15px;" onclick="addProduct()">Add Product</button>
                <table id="productTable">
                    <thead><tr><th>Product</th><th>HSN</th><th>Stock</th><th>Action</th></tr></thead>
                    <tbody id="inventoryBody"></tbody>
                </table>
            </div>
        </div>

        <div id="customers" class="section">
            <div class="card">
                <h2>Customer Directory</h2>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <input id="cname" placeholder="Customer Name">
                    <input id="cphone" placeholder="Phone Number">
                </div>
                <button class="action-btn" style="margin-top:15px;" onclick="addCustomer()">Register Customer</button>
                <table>
                    <thead><tr><th>Name</th><th>Phone</th></tr></thead>
                    <tbody id="customerBody"></tbody>
                </table>
            </div>
        </div>

        <div id="billing" class="section">
            <div class="card">
                <h2>Quick GST Billing (18%)</h2>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom: 15px;">
                    <div>
                        <label>Customer</label>
                        <select id="billCustomer"><option value="">Select Customer</option></select>
                    </div>
                    <div>
                        <label>Product</label>
                        <select id="billProduct"><option value="">Select Product</option></select>
                    </div>
                </div>
                <input type="number" id="billQty" placeholder="Quantity to Sell">
                <button class="action-btn" style="margin-top:10px;" onclick="createInvoice()">Generate & Save Bill</button>
                
                <div id="invoiceOutput" style="margin-top:20px;"></div>
            </div>
        </div>

        <div id="ai" class="section">
            <div class="card">
                <h2>AI Growth Advisor</h2>
                <p style="color:#94a3b8">Get instant insights based on your store's real data.</p>
                <input id="aiQuestion" placeholder="Example: Analysis of my current stock and profit margins?">
                <button class="action-btn" style="width:150px; margin-top:10px;" onclick="generateAI()">Ask AI</button>
                <div id="aiOutput" style="margin-top:20px; padding:20px; background:#0f172a; border-radius:12px; line-height: 1.6; border: 1px solid #1e293b;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let products = [];
    let customers = [];
    let totals = { rev: 0, profit: 0, gst: 0 };
    
    // API KEY FOR TESTING
    const GROQ_API_KEY = "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";

    function login() {
        if(document.getElementById('username').value === "admin" && document.getElementById('password').value === "1234") {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        } else { alert("Invalid Credentials"); }
    }

    function showTab(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active-section'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active-section');
        event.currentTarget.classList.add('active');
    }

    function addProduct() {
        if(!pname.value || !pqty.value) return alert("Fill details");
        const p = { 
            name: pname.value, 
            hsn: pcategory.value || "N/A", 
            cost: parseFloat(pcost.value) || 0, 
            sell: parseFloat(psell.value) || 0, 
            qty: parseInt(pqty.value) || 0 
        };
        products.push(p);
        renderInventory();
        updateLists();
        updateStats();
        // Clear fields
        pname.value = ''; pcost.value = ''; psell.value = ''; pqty.value = '';
    }

    function addCustomer() {
        if(!cname.value) return alert("Enter Name");
        customers.push({ name: cname.value, phone: cphone.value || "N/A" });
        renderCustomers();
        updateLists();
        cname.value = ''; cphone.value = '';
    }

    function renderInventory() {
        inventoryBody.innerHTML = products.map((p, i) => `
            <tr>
                <td>${p.name}</td>
                <td>${p.hsn}</td>
                <td style="color: ${p.qty < 5 ? '#ef4444' : 'inherit'}">${p.qty}</td>
                <td><button onclick="products.splice(${i},1); renderInventory(); updateLists();" style="background:none; border:none; color:#ef4444; cursor:pointer;">Delete</button></td>
            </tr>`).join('');
    }

    function renderCustomers() {
        customerBody.innerHTML = customers.map(c => `<tr><td>${c.name}</td><td>${c.phone}</td></tr>`).join('');
    }

    function updateLists() {
        billProduct.innerHTML = '<option value="">Select Product</option>' + products.map((p, i) => `<option value="${i}">${p.name} (Stock: ${p.qty})</option>`).join('');
        billCustomer.innerHTML = '<option value="">Select Customer</option>' + customers.map((c, i) => `<option value="${i}">${c.name}</option>`).join('');
    }

    function updateStats() {
        rev.innerText = "‚Çπ" + totals.rev.toFixed(0);
        profit.innerText = "‚Çπ" + totals.profit.toFixed(0);
        gstTotal.innerText = "‚Çπ" + totals.gst.toFixed(0);
        invValue.innerText = "‚Çπ" + products.reduce((acc, p) => acc + (p.cost * p.qty), 0).toFixed(0);
    }

    // UPDATED: BILLING + INVOICE SLIP LOGIC
    function createInvoice() {
        const pIndex = billProduct.value;
        const cIndex = billCustomer.value;
        
        if(pIndex === "" || cIndex === "") return alert("Please select both customer and product");

        const p = products[pIndex];
        const c = customers[cIndex];
        const q = parseInt(billQty.value);

        if(!p || q > p.qty || q <= 0) return alert("Invalid quantity or out of stock");
        
        const subtotal = p.sell * q;
        const gstAmount = subtotal * 0.18; 
        const totalAmount = subtotal + gstAmount;

        // Financial Updates
        p.qty -= q;
        totals.rev += totalAmount;
        totals.gst += gstAmount;
        totals.profit += (p.sell - p.cost) * q;
        
        updateStats();
        renderInventory();
        updateLists();

        // UI Confirmation + Print Button
        invoiceOutput.innerHTML = `
            <div style="padding:20px; border:2px solid var(--accent); border-radius:12px; background: rgba(16, 185, 129, 0.05); text-align:center;">
                <h3 style="margin-top:0; color:var(--accent);">üéâ Transaction Successful</h3>
                <p>Invoice for <b>${c.name}</b>: ‚Çπ${totalAmount.toFixed(2)}</p>
                <button class="action-btn" style="background:#10b981; width:auto;" 
                    onclick="printSlip('${c.name}', '${c.phone}', '${p.name}', ${q}, ${p.sell}, ${gstAmount}, ${totalAmount})">
                    üñ®Ô∏è Print Invoice Slip
                </button>
            </div>`;
    }

    function printSlip(custName, custPhone, prodName, qty, rate, gst, total) {
        const printWindow = window.open('', '_blank', 'width=450,height=600');
        const invNo = "METO-" + Math.floor(Math.random() * 9999);
        const date = new Date().toLocaleString();

        printWindow.document.write(`
            <html>
            <head>
                <title>Invoice ${invNo}</title>
                <style>
                    body { font-family: 'Courier New', monospace; padding: 20px; line-height: 1.2; font-size: 14px; }
                    .center { text-align: center; }
                    .dashed { border-bottom: 1px dashed #000; margin: 10px 0; }
                    .row { display: flex; justify-content: space-between; margin: 5px 0; }
                    .bold { font-weight: bold; }
                </style>
            </head>
            <body onload="window.print(); window.close();">
                <div class="center">
                    <h2 style="margin:0">METOCART AI</h2>
                    <p>Smart Retail Solutions<br>GSTIN: 27METO9988X1Z1</p>
                </div>
                <div class="dashed"></div>
                <p><b>INV NO:</b> ${invNo}<br><b>DATE:</b> ${date}</p>
                <p><b>CUSTOMER:</b> ${custName}<br><b>PHONE:</b> ${custPhone}</p>
                <div class="dashed"></div>
                <div class="row bold"><span>ITEM</span><span>QTY</span><span>TOTAL</span></div>
                <div class="row"><span>${prodName} (@${rate})</span><span>${qty}</span><span>${(qty*rate).toFixed(2)}</span></div>
                <div class="dashed"></div>
                <div class="row"><span>Taxable Value:</span><span>‚Çπ${(qty*rate).toFixed(2)}</span></div>
                <div class="row"><span>GST (18%):</span><span>‚Çπ${gst.toFixed(2)}</span></div>
                <div class="row bold" style="font-size:16px;"><span>GRAND TOTAL:</span><span>‚Çπ${total.toFixed(2)}</span></div>
                <div class="dashed"></div>
                <p class="center" style="margin-top:20px;">~ Thank You! ~<br>Powered by Metocart AI</p>
            </body>
            </html>
        `);
        printWindow.document.close();
    }

    async function generateAI() {
        const aiOutput = document.getElementById('aiOutput');
        const question = document.getElementById('aiQuestion').value;
        if (!question) return alert("Ask a question first.");

        aiOutput.innerHTML = "‚è≥ Metocart AI is crunching the numbers...";

        try {
            const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${GROQ_API_KEY}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: "llama-3.3-70b-versatile",
                    messages: [
                        { role: "system", content: "You are the Metocart AI Business Advisor. Provide professional, short, bulleted retail advice for the Indian market. Use the data provided." },
                        { role: "user", content: `Data: Revenue ‚Çπ${totals.rev}, Profit ‚Çπ${totals.profit}, GST ‚Çπ${totals.gst}, Products: ${JSON.stringify(products)}. Question: ${question}` }
                    ]
                })
            });
            const data = await response.json();
            aiOutput.innerHTML = `<b>AI Insights:</b><br>${data.choices[0].message.content.replace(/\n/g, "<br>")}`;
        } catch (e) {
            aiOutput.innerHTML = "<span style='color:#ef4444'>AI Error. Check Connection.</span>";
        }
    }
</script>
</body>
</html>
